name: "Test Dev Container Templates"

on:
  push:
    branches: [main]
    paths:
      - "src/**"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        template:
          - full-stack
          - rust-agentic
          - node-agentic
          - python-agentic
    steps:
      - uses: actions/checkout@v4

      - name: Validate template JSON
        run: |
          python3 -c "
          import json, sys, re

          # devcontainer-template.json must be strict JSON
          with open('src/${{ matrix.template }}/devcontainer-template.json') as f:
              meta = json.load(f)
          assert 'id' in meta, 'Missing id'
          assert 'version' in meta, 'Missing version'
          print(f\"Template: {meta['id']} v{meta['version']}\")

          # devcontainer.json is JSONC (may have comments) â€” strip and parse
          with open('src/${{ matrix.template }}/.devcontainer/devcontainer.json') as f:
              content = f.read()
          stripped = re.sub(r'//.*', '', content)
          config = json.loads(stripped)
          assert 'features' in config, 'Missing features'
          features = list(config.get('features', {}).keys())
          print(f\"Features ({len(features)}): {', '.join(f.split('/')[-1] for f in features)}\")
          "
